<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Rhythm Training</title>
<script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
<style>
body {
  min-height: 100vh;
  margin: 0;
  background: linear-gradient(135deg,#ffecb3 0%,#a7ffeb 100%);
  font-family: 'Segoe UI', 'Montserrat', Arial, sans-serif;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.header {
  width: 100vw;
  padding-top: 2rem;
  text-align: center;
  font-size: 2.5rem;
  letter-spacing: .13em;
  font-weight: 900;
  color: #332a23;
  text-shadow: 0 2px 20px #ffe082cc, 0 2px 2px #1919191a;
  margin-bottom: 0.2em;
  user-select: none;
  font-family: 'Montserrat', 'Segoe UI', Arial, sans-serif;
}
#controls {
  margin: 1.2rem 0 1.5rem;
  display: flex;
  gap: 1.6rem;
  align-items: center;
  background: #fff6e3cc;
  border-radius: 2em;
  padding: 0.7em 1.7em 0.7em 1.7em;
  box-shadow: 0 2px 12px #fff8, 0 1.5px 2px #0002;
}
#controls label, #controls select, #controls button {
  font-size: 1.08rem;
  font-family: 'Montserrat', Arial, sans-serif;
}
#controls button {
  background: linear-gradient(90deg,#29b6f6 0%,#8e24aa 100%);
  color: #fff;
  font-weight: bold;
  border: none;
  border-radius: 1em;
  padding: 0.5em 1.6em;
  box-shadow: 0 3px 12px #673ab71a, 0 1px 2px #0002;
  cursor: pointer;
  transition: background 0.18s;
}
#controls button:hover {
  background: linear-gradient(90deg,#0288d1 0%,#ad1457 100%);
}
#beats-area {
  flex: 1;
  width: 100vw;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  position: relative;
  min-height: 280px;
}
#predict, #resting-label {
  text-align: center; font-size: 2.5rem; font-weight: bold;
  letter-spacing: .11em; opacity: 0;
  transition: opacity .13s; z-index: 1;
  text-shadow: 0 4px 18px #fff8, 0 2px 4px #1913;
  position: absolute; left: 0; right: 0;
  pointer-events:none;
}
#predict { color: #23237d; top: 5px; }
#predict.show { opacity: 1; }
#resting-label { color: #d32f2f; top: 55px; letter-spacing:.19em;}
#resting-label.show { opacity: 1; }
#beats {
  display: flex; flex-direction: row; justify-content: center; align-items: end;
  gap: 2.2rem; margin-bottom: 2.4rem; width: 100%;
  margin-top: 3em;
}
.beat {
  display: flex; flex-direction: column; align-items: center; min-width: 70px;
}
.num {
  font-size: 2.2rem; font-weight: 700;
  background: linear-gradient(120deg,#ffd54f 0%,#7e57c2 100%);
  padding: .21em .74em;
  border-radius: 50%;
  box-shadow: 0 3px 12px #fff6, 0 1.5px 2px #0001;
  color: #212121;
  border: 2.7px solid #fff3;
  transition: border .16s, background .18s, color .13s, transform .14s;
  margin-bottom: 0.35em;
  user-select: none;
}
.beat.active .num {
  background: linear-gradient(120deg,#00e676 0%,#2962ff 100%);
  color: #fff;
  border-color: #81c784;
  transform: scale(1.20);
  box-shadow: 0 6px 26px #00e67644;
}
.num.resting {
  background: #eee !important; color: #bdbdbd !important; border-color: #e0e0e0 !important;
  box-shadow:none !important;
}
.label {
  font-size: 1.03rem; color: #6a6a6a; margin-top: -.13em; font-family: 'Montserrat', Arial, sans-serif; letter-spacing:0.06em;
  text-shadow: 0 2px 6px #fff3;
}
@media (max-width: 650px) {
  .header {font-size:1.4rem;}
  #beats { gap: 1rem; }
  .num { font-size: 1.2rem; }
  #predict, #resting-label { font-size: 1.1rem; }
  #controls {padding:.3em .6em .4em .6em;}
}
</style>
</head>
<body>
<div class="header">Rhythm Training</div>
<div id="controls">
  <label>BPM: <input id="bpm" type="number" value="120" min="30" max="300" style="width:70px"></label>
  <select id="mode-select">
    <option value="2m" selected>Pattern changes every 2 bars</option>
    <option value="1m">Pattern changes every bar</option>
  </select>
  <button id="toggle">Start</button>
</div>

<div id="beats-area">
  <div id="predict">Change</div>
  <div id="resting-label">Rest</div>
  <div id="beats">
    <div class="beat"><div class="num">-</div><div class="label">Beat 1</div></div>
    <div class="beat"><div class="num">-</div><div class="label">Beat 2</div></div>
    <div class="beat"><div class="num">-</div><div class="label">Beat 3</div></div>
    <div class="beat"><div class="num">-</div><div class="label">Beat 4</div></div>
  </div>
</div>

<script>
let hi, beep, sustain;
function createSynths(){
  hi = new Tone.MetalSynth({
    frequency:400,envelope:{attack:.001,decay:.09,release:.03},
    resonance:4400,octaves:1.5,volume:-8
  }).toDestination();
  beep = new Tone.Synth({
    oscillator:{type:"square"},
    envelope:{attack:.001,decay:.12,sustain:0,release:.06}
  }).toDestination();
  sustain = new Tone.Synth({
    oscillator:{type:"triangle"},
    envelope:{attack:0.01, decay:0.25, sustain:0.9, release:0.7}
  }).toDestination();
}
createSynths();

const beats = Array.from(document.querySelectorAll(".beat"));
const nums  = Array.from(document.querySelectorAll(".num"));
const predict = document.getElementById("predict");
const restLabel = document.getElementById("resting-label");
const modeSelect = document.getElementById("mode-select");

let pattern = [];
let running=false;
let modeHandle = null;
let interval = "2m";
let phraseLen = 8;         // 2小節(8拍)/1小節(4拍)モード
let stepInPhrase = 0;      // 0~(phraseLen-1):通常拍, phraseLen:休符, phraseLen+1:Change/パターン切替

function newPattern(old){
  let p;
  do {
    p = Array.from({length:4},()=>[1,2,3,4][Math.floor(Math.random()*4)]);
  } while(JSON.stringify(p)===JSON.stringify(old));
  return p;
}
function clearPatternUI() {
  nums.forEach(n=>n.textContent="-");
  beats.forEach(b=>b.classList.remove("active"));
  nums.forEach(n=>n.classList.remove("resting"));
  predict.classList.remove("show");
  restLabel.classList.remove("show");
}
function startPattern(reset=true){
  if(reset){
    pattern = newPattern([]);
    nums.forEach((n,i)=>n.textContent=pattern[i]);
    beats.forEach(b=>b.classList.remove("active"));
    nums.forEach(n=>n.classList.remove("resting"));
    predict.classList.remove("show");
    restLabel.classList.remove("show");
    stepInPhrase = 0;
  }
}
function scheduleBeatEngine(){
  if(modeHandle) Tone.Transport.clear(modeHandle);
  interval = modeSelect.value;
  phraseLen = (interval==="2m"?8:4);
  startPattern(true);
  modeHandle = Tone.Transport.scheduleRepeat(time=>{
    // 1. 通常の拍進行
    if(stepInPhrase < phraseLen){
      const beatNum = stepInPhrase % 4;
      hi.triggerAttackRelease("16n",time);
      Tone.Draw.schedule(()=>{
        beats.forEach((b,i)=>b.classList.toggle("active",i===beatNum));
        nums.forEach(n=>n.classList.remove("resting"));
        restLabel.classList.remove("show");
        predict.classList.remove("show");
      },time);
    }
    // 2. 休符（Rest）
    if(stepInPhrase === phraseLen){
      Tone.Draw.schedule(()=>{
        beats.forEach(b=>b.classList.remove("active"));
        nums.forEach(n=>n.classList.add("resting"));
        restLabel.classList.add("show");
        predict.classList.remove("show");
      },time);
      sustain.triggerAttackRelease("C5", Tone.Time("4n").toSeconds(), time);
    }
    // 3. Change表示（休符終わりの直前に）
    if(stepInPhrase === phraseLen){
      setTimeout(()=>{
        predict.classList.add("show");
        beep.triggerAttackRelease("G6","16n");
      }, Tone.Time("4n").toMilliseconds() * 0.75);
    }
    // 4. パターン切替
    if(stepInPhrase === phraseLen+1){
      pattern = newPattern(pattern);
      nums.forEach((n,i)=>n.textContent=pattern[i]);
      nums.forEach(n=>n.classList.remove("resting"));
      beats.forEach(b=>b.classList.remove("active"));
      Tone.Draw.schedule(()=>{
        restLabel.classList.remove("show");
        predict.classList.remove("show");
      },time);
      stepInPhrase = 0;
      return;
    }else{
      stepInPhrase++;
    }
    if(stepInPhrase>phraseLen+1) stepInPhrase=0;
  },"4n");
}
const toggle = document.getElementById("toggle");
toggle.onclick=async()=>{
  if(!running){
    await Tone.start();
    Tone.Transport.stop();
    Tone.Transport.cancel();
    createSynths();
    Tone.Transport.bpm.value=+bpm.value;
    clearPatternUI();
    scheduleBeatEngine();
    Tone.Transport.start("+0.05");
    toggle.textContent="Stop"; running=true;
    modeSelect.disabled = true;
  }else{
    Tone.Transport.stop();
    clearPatternUI();
    toggle.textContent="Start"; running=false;
    if(modeHandle) Tone.Transport.clear(modeHandle);
    modeSelect.disabled = false;
    Tone.Transport.cancel();
  }
};
modeSelect.onchange = ()=>{
  if(running){
    Tone.Transport.stop();
    Tone.Transport.cancel();
    createSynths();
    clearPatternUI();
    scheduleBeatEngine();
    Tone.Transport.start("+0.05");
  }
};
bpm.onchange = ()=>{
  if(running){
    Tone.Transport.stop();
    Tone.Transport.cancel();
    createSynths();
    Tone.Transport.bpm.value=+bpm.value;
    clearPatternUI();
    scheduleBeatEngine();
    Tone.Transport.start("+0.05");
  }
};
</script>
</body>
</html>
