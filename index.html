<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Rhythm Training</title>
<script src="https://unpkg.com/tone@latest/build/Tone.js"></script>
<style>
body { background: #fafafa; font-family: 'Segoe UI', Arial, sans-serif; display: flex; flex-direction: column; align-items: center; min-height: 100vh;}
.header { padding-top: 2.2rem; text-align: center; font-size: 2.2rem; font-weight: 900; color: #222; margin-bottom: 1.3em;}
#controls { margin: 1.2rem 0 2.1rem; display: flex; gap: 1.5rem; align-items: center; }
#controls label, #controls select, #controls button, #controls input[type=checkbox] { font-size: 1.08rem;}
#controls button { background: linear-gradient(90deg,#29b6f6 0%,#8e24aa 100%); color: #fff; font-weight: bold; border: none; border-radius: 1em; padding: 0.5em 1.6em; cursor: pointer;}
#controls button:hover { background: linear-gradient(90deg,#0288d1 0%,#ad1457 100%);}
#beats-area { width: 100vw; display: flex; flex-direction: column; align-items: center; min-height: 200px;}
#beats { display: flex; flex-direction: row; justify-content: center; align-items: end; gap: 2.2rem; margin-bottom: 1.7rem; width: 100%; margin-top: 2em;}
.beat { display: flex; flex-direction: column; align-items: center; min-width: 75px;}
.num {
  font-size: 2.2rem; font-weight: 700; background: #fff; border-radius: 50%; border: 3.3px solid #111; color: #222;
  width: 2.2em; height: 2.2em; display: flex; align-items: center; justify-content: center; margin-bottom: 0.38em;
  transition: background .18s, color .11s, border .18s, box-shadow .18s, transform .16s;
  box-shadow: 0 3px 12px #aaa2, 0 1.5px 2px #0001; user-select: none;
}
.beat.active .num { background: #14e158; border-color: #111; color: #fff; box-shadow: 0 6px 26px #00e67633; transform: scale(1.18);}
.num.resting { background: #eee !important; color: #bdbdbd !important; border-color: #bbb !important; box-shadow:none !important;}
.label { font-size: 1.06rem; color: #7b7b7b; margin-top: -.13em;}
#predict, #resting-label { text-align: center; font-size: 2.1rem; font-weight: bold; letter-spacing: .11em; opacity: 0; transition: opacity .13s; position: absolute; left: 0; right: 0; pointer-events:none;}
#predict { color: #23237d; top: 5px; }
#predict.show { opacity: 1; }
#resting-label { color: #d32f2f; top: 55px; letter-spacing:.19em;}
#resting-label.show { opacity: 1; }
@media (max-width: 650px) { .header {font-size:1.4rem;} #beats { gap: 1rem; } .num { font-size: 1.1rem; width:1.1em; height:1.1em; } #predict, #resting-label { font-size: 1.1rem; } #controls {padding:.3em .6em .4em .6em;}}
</style>
</head>
<body>
<div class="header">Rhythm Training</div>
<div id="controls">
  <label for="bpm">BPM: <input id="bpm" type="number" value="100" min="30" max="300" style="width:70px"></label>
  <label for="mode-select">Pattern Change:
    <select id="mode-select">
      <option value="2m" selected>Pattern changes every 2 bars</option>
      <option value="1m">Pattern changes every bar</option>
    </select>
  </label>
  <label for="rest-onoff">
    Rest (Pause) Enabled:
    <input id="rest-onoff" type="checkbox" checked>
  </label>
  <button id="toggle">Start</button>
</div>
<div id="beats-area" style="position:relative;">
  <div id="predict">Change</div>
  <div id="resting-label">Rest</div>
  <div id="beats">
    <div class="beat"><div class="num">-</div><div class="label">Beat 1</div></div>
    <div class="beat"><div class="num">-</div><div class="label">Beat 2</div></div>
    <div class="beat"><div class="num">-</div><div class="label">Beat 3</div></div>
    <div class="beat"><div class="num">-</div><div class="label">Beat 4</div></div>
  </div>
</div>
<script>
let clickStrong, clickWeak, sustain;
function createSynths(){
  // 拍頭（強）クリック
  clickStrong = new Tone.MembraneSynth({
    pitchDecay: 0.01,
    octaves: 4,
    oscillator: {type: "sine"},
    envelope: {attack: 0.001, decay: 0.10, sustain: 0, release: 0.01},
    volume: 5
  }).toDestination();
  // サブビート（弱）クリック
  clickWeak = new Tone.MembraneSynth({
    pitchDecay: 0.003,
    octaves: 2.5,
    oscillator: {type: "sine"},
    envelope: {attack: 0.001, decay: 0.10, sustain: 0, release: 0.01},
    volume: -2
  }).toDestination();
  sustain = new Tone.Synth({
    oscillator: {type: "triangle"},
    envelope: {attack: 0.01, decay: 0.25, sustain: 0.8, release: 0.6}
  }).toDestination();
}
createSynths();

const beats = Array.from(document.querySelectorAll(".beat"));
const nums  = Array.from(document.querySelectorAll(".num"));
const predict = document.getElementById("predict");
const restLabel = document.getElementById("resting-label");
const modeSelect = document.getElementById("mode-select");
const restOnOff = document.getElementById("rest-onoff");

let pattern = [];
let running=false;
let handle = null;
let interval = "2m";
let phraseLen = 8;
let subPerBeat = 4; // 16分音符単位

function newPattern(old){
  let p;
  do {
    p = Array.from({length:4},()=>[1,2,3,4][Math.floor(Math.random()*4)]);
  } while(JSON.stringify(p)===JSON.stringify(old));
  return p;
}
function startPattern(){
  pattern = newPattern(pattern);
  nums.forEach((n,i)=>n.textContent=pattern[i]);
  beats.forEach(b=>b.classList.remove("active"));
  nums.forEach(n=>n.classList.remove("resting"));
  predict.classList.remove("show");
  restLabel.classList.remove("show");
}
function clearPatternUI() {
  nums.forEach(n=>n.textContent="-");
  beats.forEach(b=>b.classList.remove("active"));
  nums.forEach(n=>n.classList.remove("resting"));
  predict.classList.remove("show");
  restLabel.classList.remove("show");
}

// 完全グリッド方式
function scheduleBeatEngine(){
  if(handle) Tone.Transport.clear(handle);
  interval = modeSelect.value;
  phraseLen = (interval==="2m"?8:4); // 拍数
  startPattern();
  const restEnabled = restOnOff.checked;
  let subIdx = 0; // 16分グリッドで進行
  let subPerBar = 4*subPerBeat;
  let totalSubs = phraseLen*subPerBeat;
  let stepForChange = restEnabled ? totalSubs+subPerBeat : totalSubs;

  handle = Tone.Transport.scheduleRepeat(time=>{
    let beatIdx = Math.floor(subIdx/subPerBeat)%4;
    let subInBeat = subIdx%subPerBeat;
    let inPhrase = subIdx<totalSubs;
    let subdiv = Number(nums[beatIdx].textContent);

    // 拍頭
    if(subInBeat===0 && inPhrase){
      Tone.Draw.schedule(()=>{
        beats.forEach((b,i)=>b.classList.toggle("active",i===beatIdx));
        nums.forEach(n=>n.classList.remove("resting"));
        restLabel.classList.remove("show");
        predict.classList.remove("show");
      },time);
      clickStrong.triggerAttackRelease("C5", "8n", time);
    }
    // サブクリック（拍頭含め、数字分だけ等間隔で鳴らす。ただし拍頭は強クリック、他は弱クリック）
    if(subInBeat<subdiv && inPhrase){
      if(subInBeat!==0){
        clickWeak.triggerAttackRelease("C5","16n",time);
      }
    }

    // 休符
    if(restEnabled && subIdx===totalSubs){
      Tone.Draw.schedule(()=>{
        beats.forEach(b=>b.classList.remove("active"));
        nums.forEach(n=>n.classList.add("resting"));
        restLabel.classList.add("show");
        predict.classList.remove("show");
      },time);
      sustain.triggerAttackRelease("C4", Tone.Time("4n").toSeconds(), time);
      setTimeout(()=>{predict.classList.add("show");}, Tone.Time("4n").toMilliseconds() * 0.7);
    }

    // パターンチェンジ
    if(subIdx===stepForChange){
      startPattern();
      subIdx = 0;
      return;
    }
    subIdx++;
    if(subIdx>stepForChange) subIdx=0;
  }, "16n");
}

const toggle = document.getElementById("toggle");
toggle.onclick=async()=>{
  if(!running){
    await Tone.start();
    Tone.Transport.stop();
    Tone.Transport.cancel();
    createSynths();
    Tone.Transport.bpm.value=+bpm.value;
    clearPatternUI();
    scheduleBeatEngine();
    Tone.Transport.start("+0.05");
    toggle.textContent="Stop"; running=true;
    modeSelect.disabled = true;
    restOnOff.disabled = true;
  }else{
    Tone.Transport.stop();
    clearPatternUI();
    toggle.textContent="Start"; running=false;
    if(handle) Tone.Transport.clear(handle);
    modeSelect.disabled = false;
    restOnOff.disabled = false;
    Tone.Transport.cancel();
  }
};
modeSelect.onchange = ()=>{
  if(running){
    Tone.Transport.stop();
    Tone.Transport.cancel();
    createSynths();
    clearPatternUI();
    scheduleBeatEngine();
    Tone.Transport.start("+0.05");
  }
};
bpm.onchange = ()=>{
  if(running){
    Tone.Transport.stop();
    Tone.Transport.cancel();
    createSynths();
    Tone.Transport.bpm.value=+bpm.value;
    clearPatternUI();
    scheduleBeatEngine();
    Tone.Transport.start("+0.05");
  }
};
restOnOff.onchange = ()=>{
  if(running){
    Tone.Transport.stop();
    Tone.Transport.cancel();
    createSynths();
    clearPatternUI();
    scheduleBeatEngine();
    Tone.Transport.start("+0.05");
  }
};
</script>
</body>
</html>
